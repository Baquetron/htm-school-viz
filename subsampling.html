<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>SDR Subsampling</title>

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
          crossorigin="anonymous">
    <link rel="stylesheet" href="css/jquery-ui.min.css">

    <link rel="stylesheet" href="css/styles.css">

    <style>
        body {
            margin: 20px 40px;
        }
        svg {
            width: 500px;
            height: 500px;
        }
        #match {
            font-size: 20pt;
            text-align: center;
            padding: 20px;
            border: solid grey 1px;
            border-radius: 10px;
        }
        .slider {
            width: 600px;
            margin: 0 40px;
        }
        .props td {
            margin: 0;
            padding: 0;
            line-height: 1;
        }
        .data-label, .data {
            font-size: 20pt;
        }
        #match {
            width: 140px;
        }
    </style>


</head>
<body>

<div class="container-fluid">

    <div class="back-button">
        <a href="index.html">BACK</a>
    </div>

    <h1>SDR Subsampling</h1>

    <table>
        <tbody>

        <tr>
            <td id="sdr-x"></td>
            <td id="sdr-xprime"></td>
            <td id="sdr-y"></td>
            <td id="sdr-comparison"></td>
        </tr>

        <tr>
            <td valign="top" colspan="2">
                <table><tbody>
                <tr>
                    <td colspan="3" align="center">
                        <div class="btn-group" role="group">
                            <button type="button" id="ex1" class="btn btn-primary btn-lg">Example 1</button>
                            <button type="button" id="ex2" class="btn btn-primary btn-lg">Example 2</button>
                            <button type="button" id="ex3" class="btn btn-primary btn-lg">Example 3</button>
                        </div>
                    </td>
                </tr>
                <tr><td colspan="3"><hr/></td></tr>
                <tr>
                    <td class="data-label">n</td>
                    <td>
                        <div id="n-slider" class="slider"></div>
                    </td>
                    <td class="n-display data"></td>
                </tr>
                <tr>
                    <td class="data-label">w</td>
                    <td>
                        <div id="w-slider" class="slider"></div>
                    </td>
                    <td class="w-display data"></td>
                </tr>
                <tr>
                    <td class="data-label">sample %</td>
                    <td>
                        <div id="sample-slider" class="slider"></div>
                    </td>
                    <td class="sample-display data"></td>
                </tr>
                <tr>
                    <td class="data-label">&theta;</td>
                    <td>
                        <div id="theta-slider" class="slider"></div>
                    </td>
                    <td class="theta-display data"></td>
                </tr>
                <tr>
                    <td class="data-label">w<sub>y</sub></td>
                    <td>
                        <div id="wy-slider" class="slider"></div>
                    </td>
                    <td class="wy-display data"></td>
                </tr>
                </tbody></table>
            </td>
            <td valign="top">
                <button type="button" id="next" class="btn btn-primary btn-lg">Try Another Random y</button>
                <h2>Chance of False Positive:</h2>
                <div id="false-positive-display" class="data"></div>
                <div id="match"></div>
            </td>
            <td></td>
        </tr>


        </tbody>
    </table>

</div>

<script id="props-tmpl" type="text/x-handlebars-template">
    <h2>{{title}}</h2>
    <table class="props">
        <tbody>
        {{#each props}}
        <tr style="{{rowStyle}}">
            <td class="data-label">{{label}}:</td>
            <td id="{{label}}-display" class="data">{{data}}</td>
        </tr>
        {{/each}}
        </tbody>
    </table>
</script>

<script src="https://cdn.jsdelivr.net/handlebarsjs/4.0.5/handlebars.min.js"></script>
<script src="https://cdn.jsdelivr.net/lodash/4.7.0/lodash.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="js/d3.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/math.min.js"></script>

<script src="js/sdr.js"></script>
<script src="js/tools.js"></script>

<script>
    $(function () {
        var n = 1024;
        var w = 8;
        var theta = 2;
        var sample = 0.5;
        var wy = w;

        var x = SDR.tools.getRandom(n, w / n);
        var xprime = SDR.tools.subsample(x, sample);
        var y = SDR.tools.getRandom(n, wy / n);

        var $nSlider = $('#n-slider');
        var $nDisplay = $('.n-display');
        var $wSlider = $('#w-slider');
        var $wDisplay = $('.w-display');
        var $sampleSlider = $('#sample-slider');
        var $sampleDisplay = $('.sample-display');
        var $thetaSlider = $('#theta-slider');
        var $thetaDisplay = $('.theta-display');
        var $wySlider = $('#wy-slider');
        var $wyDisplay = $('.wy-display');
        var $fpDisplay = $('#false-positive-display');
        var $match = $('#match');

        var leftColor = "orange";
        var rightColor = "green";
        var size = 30;

        function sdrsMatch(left, right) {
            return SDR.tools.population(SDR.tools.overlap(left, right)) >= theta;
        }

        function updateDisplayValues() {
            var overlapSet, falsePosProbability, falsePosOdds;
            var wxPrime = SDR.tools.population(xprime);
            if (theta > wxPrime) {
                theta = wxPrime;
            }
            $nDisplay.html(n);
            $wDisplay.html(w);
            $sampleDisplay.html(sample);
            $thetaDisplay.html(theta);
            $wyDisplay.html(wy);
            // sliders
            $wSlider.slider('value', w);
            $wySlider.slider('value', wy);
            $thetaSlider.slider('value', theta);
            $sampleSlider.slider('value', sample);
            $nSlider.slider('value', n);

            $wSlider.slider('option', 'max', n);
            $thetaSlider.slider('option', 'max', wxPrime);
            $wySlider.slider('option', 'max', n);
            $wySlider.slider('option', 'min', wxPrime);

            overlapSet = SDR.tools._getOverlapSet(n, SDR.tools.population(xprime), theta, wy);
            if (isFinite(overlapSet)) {
                falsePosProbability = math.divide(overlapSet, SDR.tools._getUniqueness(n, wy));
            } else {
                falsePosProbability = '&infin;';
            }

            $fpDisplay.html(falsePosProbability);
            if (sdrsMatch(xprime, y)) {
                $match.html('MATCH').removeClass('bg-danger').addClass('bg-success');
            } else {
                $match.html('NOPE').removeClass('bg-success').addClass('bg-danger');
            }
        }

        function validatePotentialValues(myN, myW, myWy, wxPrime) {
            return myW <= myN && wxPrime <= myWy;
        }

        function drawSliders() {
            function slide(event, ui) {
                var source = event.target.id;
                var myN = n;
                var myW = w;
                var myWy = wy;
                var mySample = sample;
                var wxPrime = SDR.tools.population(xprime);

                if (source == 'sample-slider') {
                    mySample = ui.value;
                } else if (source == 'theta-slider') {
                    theta = ui.value;
                } else if (source == 'wy-slider') {
                    myWy = ui.value;
                } else if (source == 'n-slider') {
                    myN = ui.value;
                } else if (source == 'w-slider') {
                    myW = ui.value;
                }

                if (myWy < wxPrime) {
                    myWy = wxPrime;
                }

                if (validatePotentialValues(myN, myW, myWy, wxPrime)) {
                    drawSdrs(myN, myW, mySample, myWy);
                    updateDisplayValues();
                } else {
                    event.preventDefault();
                }
            }

            $nSlider.slider({
                min: 256,
                max: 2048,
                value: n,
                step: 1,
                slide: slide
            });
            $wSlider.slider({
                min: 1,
                max: n,
                value: w,
                step: 1,
                slide: slide
            });
            $sampleSlider.slider({
                min: 0.0,
                max: 1.0,
                value: sample,
                step: 0.01,
                slide: slide
            });
            $thetaSlider.slider({
                min: 0,
                max: SDR.tools.population(xprime),
                value: theta,
                step: 1,
                slide: slide
            });
            $wySlider.slider({
                min: 0,
                max: n,
                value: wy,
                step: 1,
                slide: slide
            });
        }

        function drawSdrs(myN, myW, mySample, myWy, force) {
            var drawX = false;
            var drawXPrime = false;
            var drawY = false;

            if (myN !== n || myW !== w) {
                n = myN;
                w = myW;
                drawX = true;
                drawXPrime = true;
                drawY = true;
            }

            if (mySample !== sample) {
                sample = mySample;
                drawXPrime = true;
            }

            if (myWy !== wy) {
                wy = myWy;
                drawY = true;
            }

            if (force || drawX) {
                x = SDR.tools.getRandom(n, w / n);
                SDR.draw(x, 'sdr-x', {
                    title: 'Original SDR x',
                    size: size
                });
            }

            if (force || drawXPrime) {
                xprime = SDR.tools.subsample(x, sample);
                SDR.draw(xprime, 'sdr-xprime', {
                    title: 'x\' (subsampled)',
                    color: leftColor,
                    size: size
                });
            }

            if (force || drawY) {
                y = SDR.tools.getRandom(n, wy / n);
                SDR.draw(y, 'sdr-y', {
                    title: 'y (random)',
                    color: rightColor,
                    size: size
                });
            }

            SDR.drawComparison(xprime, y, 'sdr-comparison', {
                title: 'x\' compared to y',
                colors: {left: leftColor, right: rightColor},
                size: size
            });

        }

        function example1() {
            drawSdrs(1024, 8, 0.5, 8);
            theta = 2;
            updateDisplayValues();
        }

        function example2() {
            drawSdrs(1024, 20, 0.5, 20);
            theta = 5;
            updateDisplayValues();
        }

        function example3() {
            drawSdrs(2048, 40, 0.5, 40);
            theta = 10;
            updateDisplayValues();
        }

        $('button').click(function() {
            if (this.id == 'ex1') {
                example1();
            } else if (this.id == 'ex2') {
                example2();
            } else if (this.id == 'ex3') {
                example3();
            } else if (this.id == 'next') {
                y = SDR.tools.getRandom(n, wy / n);
                SDR.draw(y, 'sdr-y', {
                    title: 'y = (random)',
                    color: rightColor,
                    size: size
                });
                SDR.drawComparison(xprime, y, 'sdr-comparison', {
                    title: 'Comparison',
                    colors: {left: leftColor, right: rightColor},
                    size: size
                });
                updateDisplayValues();
            }
        });

        drawSliders();
        drawSdrs(n, w, sample, wy, true);
        updateDisplayValues();

    });
</script>

<a href="https://github.com/nupic-community/sdr-viz"><img
        style="position: absolute; top: 0; right: 0; border: 0;"
        src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67"
        alt="Fork me on GitHub"
        data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>

</body>
</html>